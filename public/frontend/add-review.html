<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajouter un Avis - Analyse d'Avis</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav id="navbar"></nav>

    <div class="container">
        <h1>âœï¸ Ajouter un Avis</h1>

        <div class="card">
            <form id="reviewForm">
                <div class="form-group">
                    <label for="content">Contenu de l'avis</label>
                    <textarea
                        id="content"
                        name="content"
                        rows="8"
                        required
                        minlength="10"
                        maxlength="5000"
                        placeholder="Ã‰crivez votre avis ici..."
                    ></textarea>
                    <small id="charCount">0 / 5000 caractÃ¨res</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="testAnalyzeBtn">ğŸ§ª Tester l'analyse</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ CrÃ©er l'avis</button>
                </div>
            </form>
        </div>

        <!-- RÃ©sultats de l'analyse -->
        <div id="analysisResult" class="card" style="display: none; margin-top: 20px;">
            <h3>ğŸ“Š RÃ©sultat de l'analyse</h3>
            <div class="analysis-details">
                <div class="analysis-item">
                    <strong>Sentiment :</strong>
                    <span id="resultSentiment" class="badge"></span>
                </div>
                <div class="analysis-item">
                    <strong>Score :</strong>
                    <span id="resultScore" class="badge-score"></span>
                </div>
                <div class="analysis-item">
                    <strong>ThÃ¨mes dÃ©tectÃ©s :</strong>
                    <div id="resultTopics"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // VÃ©rifier l'authentification
        checkAuth();

        // CrÃ©er la navbar
        createNavbar('add-review');

        const contentTextarea = document.getElementById('content');
        const charCount = document.getElementById('charCount');
        const reviewForm = document.getElementById('reviewForm');
        const testAnalyzeBtn = document.getElementById('testAnalyzeBtn');
        const analysisResult = document.getElementById('analysisResult');

        // Compteur de caractÃ¨res
        contentTextarea.addEventListener('input', () => {
            const length = contentTextarea.value.length;
            charCount.textContent = `${length} / 5000 caractÃ¨res`;
        });

        // Fonction pour afficher les rÃ©sultats de l'analyse
        function displayAnalysis(analysis) {
            const sentimentSpan = document.getElementById('resultSentiment');
            const scoreSpan = document.getElementById('resultScore');
            const topicsDiv = document.getElementById('resultTopics');

            // Sentiment
            sentimentSpan.textContent = getSentimentLabel(analysis.sentiment);
            sentimentSpan.className = `badge ${getSentimentClass(analysis.sentiment)}`;

            // Score
            scoreSpan.textContent = `${analysis.score} / 100`;
            scoreSpan.className = 'badge-score';

            // Topics
            topicsDiv.innerHTML = '';
            if (analysis.topics && analysis.topics.length > 0) {
                analysis.topics.forEach(topic => {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-topic';
                    badge.textContent = topic;
                    topicsDiv.appendChild(badge);
                });
            } else {
                topicsDiv.textContent = 'Aucun thÃ¨me dÃ©tectÃ©';
            }

            analysisResult.style.display = 'block';
        }

        // Tester l'analyse sans crÃ©er l'avis
        testAnalyzeBtn.addEventListener('click', async () => {
            const content = contentTextarea.value.trim();

            if (content.length < 10) {
                alert('Le contenu doit contenir au moins 10 caractÃ¨res');
                return;
            }

            try {
                testAnalyzeBtn.disabled = true;
                testAnalyzeBtn.textContent = 'â³ Analyse en cours...';

                const analysis = await reviewsAPI.analyze(content);
                displayAnalysis(analysis);

                testAnalyzeBtn.disabled = false;
                testAnalyzeBtn.textContent = 'ğŸ§ª Tester l\'analyse';
            } catch (error) {
                alert(error.message || 'Erreur lors de l\'analyse');
                testAnalyzeBtn.disabled = false;
                testAnalyzeBtn.textContent = 'ğŸ§ª Tester l\'analyse';
            }
        });

        // CrÃ©er l'avis
        reviewForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const content = contentTextarea.value.trim();

            if (content.length < 10) {
                alert('Le contenu doit contenir au moins 10 caractÃ¨res');
                return;
            }

            try {
                const submitBtn = reviewForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ CrÃ©ation en cours...';

                const response = await reviewsAPI.create(content);

                // Afficher le rÃ©sultat
                displayAnalysis({
                    sentiment: response.review.sentiment,
                    score: response.review.score,
                    topics: response.review.topics
                });

                alert('âœ… Avis crÃ©Ã© avec succÃ¨s !');

                // Rediriger vers la liste des avis aprÃ¨s 2 secondes
                setTimeout(() => {
                    window.location.href = 'reviews.html';
                }, 2000);

            } catch (error) {
                alert(error.message || 'Erreur lors de la crÃ©ation de l\'avis');
                const submitBtn = reviewForm.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ’¾ CrÃ©er l\'avis';
            }
        });
    </script>
</body>
</html>

